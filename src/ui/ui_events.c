// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.0
// LVGL version: 8.3.11
// Project name: SquareLine_Project

#include "ui.h"
#include "hid_dev.h"
#include "esp_log.h"
#include "sequences.h"
#include "sounds.h"
#include "i2s_player.h"
#include "main.h"
#include "configration.h"
#include "ui_assignment.h"

// 4 user button list
lv_obj_t *buttons[5];
const int userStratagemAmount = 5;
// Stratagem list index of user buttons
int indices[5];
// Strategem item colors of user buttons
lv_color_t colors[5];
// Amount of user assigned stratagems
uint8_t strategemsAmount = 0;

// HID input mask for special keys
#define INPUT_CTRL_MASK 1 // 1 CTRL left

// Unassign stratagem item from button
void deselectStratagem(lv_event_t *e)
{
	for (uint8_t c = 0; c < userStratagemAmount; c++)
	{
		if (buttons[c] == e->target)
		{
			buttons[c] = NULL;
			indices[c] = 0;
			colors[c] = lv_color_hex(0xffffff);
		}
	}

	updateStratagemSelection();

	playbackSound("S:assets/sound/_des.wav");
}

// Assign stratagem item from button
void selectStratagem(lv_event_t *e)
{
	if (strategemsAmount < userStratagemAmount)
	{
		for (uint8_t c = 0; c < userStratagemAmount; c++)
		{
			if (buttons[c] == NULL)
			{
				buttons[c] = e->target;
				indices[c] = (int)lv_obj_get_user_data(e->target);

				lv_obj_clear_state(e->target, LV_STATE_CHECKED);
				lv_color_t borderColor = lv_obj_get_style_border_color(e->target, LV_PART_MAIN);
				lv_obj_add_state(e->target, LV_STATE_CHECKED);

				colors[c] = borderColor;
				break;
			}
		}

		updateStratagemSelection();

		playbackSound("S:assets/sound/_sel.wav");
	}
	else
	{
		lv_obj_clear_state(e->target, LV_STATE_CHECKED);

		playbackSound("S:assets/sound/_des.wav");
	}
}

// Update selection in UI (text and bar)
void updateStratagemSelection()
{
	strategemsAmount = 0;

	for (uint8_t c = 0; c < userStratagemAmount; c++)
	{
		if (buttons[c] != NULL)
		{
			strategemsAmount++;
		}
	}

	lv_bar_set_value(uic_BarAmount, strategemsAmount, LV_ANIM_OFF);

	char textAmount[] = "0 / 5";
	textAmount[0] = (char)(strategemsAmount + '0');

	lv_label_set_text(uic_LabelAmount, &textAmount);

	if (strategemsAmount == userStratagemAmount)
	{
		GotoGame(NULL);
	}
}

// Reset all selected stratagems from user
void resetStratagems(lv_event_t *e)
{
	if (strategemsAmount == 0)
	{
		return;
	}

	for (uint8_t c = 0; c < userStratagemAmount; c++)
	{
		if (buttons[c] != NULL)
		{
			lv_obj_clear_state(buttons[c], LV_STATE_CHECKED);
			buttons[c] = NULL;
			indices[c] = 0;
		}
	}

	updateStratagemSelection();

	playbackSound("S:assets/sound/_rst.wav");
}

// Change assigned keymap
void ChangeKeymap(lv_event_t *e)
{
	keymapIndex = lv_dropdown_get_selected(ui_DdKeymap);

	setKeymap(keymapIndex, false);
}

// Trigger 1st standard stratagem
void triggerStratagemStd1(lv_event_t *e)
{
	// Reinforce
	uint8_t sequence[8] = {INPUT_UP,
						   INPUT_DOWN,
						   INPUT_RIGHT,
						   INPUT_LEFT,
						   INPUT_UP,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	playbackSound("S:assets/sound/reinf.wav");
}

// Trigger 2nd standard stratagem
void triggerStratagemStd2(lv_event_t *e)
{
	// Resupply
	uint8_t sequence[8] = {INPUT_DOWN,
						   INPUT_DOWN,
						   INPUT_UP,
						   INPUT_RIGHT,
						   0,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	playbackSound("S:assets/sound/supp.wav");
}

// Trigger 3rd standard stratagem
void triggerStratagemStd3(lv_event_t *e)
{
	// SOS
	uint8_t sequence[8] = {INPUT_UP,
						   INPUT_DOWN,
						   INPUT_RIGHT,
						   INPUT_UP,
						   0,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	playbackSound("S:assets/sound/sos.wav");
}

// Trigger 4th standard stratagem
void triggerStratagemStd4(lv_event_t *e)
{
	// Eagle rearm
	uint8_t sequence[8] = {INPUT_UP,
						   INPUT_UP,
						   INPUT_LEFT,
						   INPUT_UP,
						   INPUT_RIGHT,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	playbackSound("S:assets/sound/eagrel.wav");
}

// Trigger 5th standard stratagem
void triggerStratagemStd5(lv_event_t *e)
{
	// Hellbomb
	uint8_t sequence[8] = {INPUT_DOWN,
						   INPUT_UP,
						   INPUT_LEFT,
						   INPUT_DOWN,
						   INPUT_UP,
						   INPUT_RIGHT,
						   INPUT_DOWN,
						   INPUT_UP};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	// playbackSound("S:assets/sound/.wav");
}

// Trigger 6th standard stratagem
void triggerStratagemStd6(lv_event_t *e)
{
	// S.E.A.F. Artillery
	uint8_t sequence[8] = {INPUT_RIGHT,
						   INPUT_UP,
						   INPUT_UP,
						   INPUT_DOWN,
						   0,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	// playbackSound("S:assets/sound/.wav");
}

// Trigger 1st user stratagem
void triggerStratagemUser1(lv_event_t *e)
{
	uint8_t itemIndex = indices[0];

	setStratagemCode(sequences[itemIndex], INPUT_CTRL_MASK, false);

	uint8_t soundIndex = soundMap[itemIndex];
	char *path = soundFiles[soundIndex];

	playbackSound(path);
}

// Trigger 2nd user stratagem
void triggerStratagemUser2(lv_event_t *e)
{
	uint8_t itemIndex = indices[1];

	setStratagemCode(sequences[itemIndex], INPUT_CTRL_MASK, false);

	uint8_t soundIndex = soundMap[itemIndex];
	char *path = soundFiles[soundIndex];

	playbackSound(path);
}

// Trigger 3rd user stratagem
void triggerStratagemUser3(lv_event_t *e)
{
	uint8_t itemIndex = indices[2];

	setStratagemCode(sequences[itemIndex], INPUT_CTRL_MASK, false);

	uint8_t soundIndex = soundMap[itemIndex];
	char *path = soundFiles[soundIndex];

	playbackSound(path);
}

// Trigger 4th user stratagem
void triggerStratagemUser4(lv_event_t *e)
{
	uint8_t itemIndex = indices[3];

	setStratagemCode(sequences[itemIndex], INPUT_CTRL_MASK, false);

	uint8_t soundIndex = soundMap[itemIndex];
	char *path = soundFiles[soundIndex];

	playbackSound(path);
}

// Trigger 5th user stratagem
void triggerStratagemUser5(lv_event_t *e)
{
	uint8_t itemIndex = indices[4];

	setStratagemCode(sequences[itemIndex], INPUT_CTRL_MASK, false);

	uint8_t soundIndex = soundMap[itemIndex];
	char *path = soundFiles[soundIndex];

	playbackSound(path);
}

// Change HID input delay
void ChangeDelay(lv_event_t *e)
{
	int32_t delay = lv_slider_get_value(e->target);

	setDelay(delay * 10, false);
}

// Change display brightness
void ChangeBrightness(lv_event_t *e)
{
	int32_t brightness = lv_slider_get_value(e->target);

	setBrightness(brightness * 10, false);
}

// Change sound mute (on/off)
void MuteSound(lv_event_t *e)
{
	bool muted = lv_obj_get_state(e->target) & LV_STATE_CHECKED ? true : false;

	setMuted(muted, false);
}

// Reset configuration to default
void ResetConfig(lv_event_t *e)
{
	resetConfig();
}

// Trigger keyboard demo (send "hello" via bluetooth connection to host)
void KeyboardDemo(lv_event_t *e)
{
	uint8_t sequence[8] = {HID_KEY_H,
						   HID_KEY_E,
						   HID_KEY_L,
						   HID_KEY_L,
						   HID_KEY_O,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, 0, true);
}

// Reboot the device
void RebootDevice(lv_event_t *e)
{
	esp_restart();
}

// Trigger when tab navigation has changed
void TabChanged(lv_event_t *e)
{
	playbackSound("S:assets/sound/_swp.wav");
}

// Change screen orientation
void FlipScreen(lv_event_t *e)
{
	bool flip = lv_obj_get_state(e->target) & LV_STATE_CHECKED ? true : false;

	setRotation(flip ? LV_DISP_ROT_270 : LV_DISP_ROT_90, false);
}

// Goto game screen
void GotoGame(lv_event_t *e)
{
	for (uint8_t c = 0; c < userStratagemAmount; c++)
	{
		const lv_obj_t *button = buttons[c];
		const lv_img_dsc_t *bgImg = lv_obj_get_style_bg_img_src(button, LV_PART_MAIN | LV_STATE_DEFAULT);
		const bool configured = buttons[c] != NULL;
		lv_obj_t *targetButton = ui_CustomStratagem1;

		bool useHiResIcon = true;

		switch (c)
		{
		case 1:
			targetButton = ui_CustomStratagem2;
			break;
		case 2:
			targetButton = ui_CustomStratagem3;
			break;
		case 3:
			targetButton = ui_CustomStratagem4;
			break;
		case 4:
			targetButton = ui_CustomStratagem5;
			useHiResIcon = false;
			break;
		}

		const lv_img_dsc_t *hires = useHiResIcon ? ResolveHiResIcon(bgImg) : bgImg;

		if (configured)
		{
			lv_obj_set_style_border_color(targetButton, colors[c], LV_PART_MAIN | LV_STATE_DEFAULT);
			lv_obj_set_style_bg_img_src(targetButton, hires, LV_PART_MAIN | LV_STATE_DEFAULT);

			lv_obj_clear_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
		else
		{
			lv_obj_add_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
	}

	_ui_screen_change(&ui_Game, LV_SCR_LOAD_ANIM_MOVE_LEFT, 1000, 100, &ui_Game_screen_init);
}

// Resolve hi-res icon from low-res assignment
lv_img_dsc_t *ResolveHiResIcon(lv_img_dsc_t *icon)
{
	lv_img_dsc_t *hires = icon;

	for (uint8_t c = 0; c < 57; c++)
	{
		lv_img_dsc_t **imgset = imgsetListTwo[c];
		lv_img_dsc_t *imgLowRes = imgset[0];

		if (icon == imgLowRes)
		{
			lv_img_dsc_t *imgHiRes = imgset[1];

			hires = imgHiRes;
			break;
		}
	}

	for (uint8_t c = 0; c < 2; c++)
	{
		lv_img_dsc_t **imgset = imgsetListFour[c];
		lv_img_dsc_t *imgLowRes1 = imgset[0];
		lv_img_dsc_t *imgLowRes2 = imgset[2];

		if (icon == imgLowRes1)
		{
			lv_img_dsc_t *imgHiRes = imgset[1];

			hires = imgHiRes;
			break;
		}
		else if (icon == imgLowRes2)
		{
			lv_img_dsc_t *imgHiRes = imgset[3];

			hires = imgHiRes;
			break;
		}
	}

	return hires;
}
