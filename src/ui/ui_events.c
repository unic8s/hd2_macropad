// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.0
// LVGL version: 8.3.11
// Project name: SquareLine_Project

#include "ui.h"
#include "ui_events.h"
#include "screens.h"
#include "hid_dev.h"
#include "esp_log.h"
#include "stratagems.h"
#include "i2s_player.h"
#include "main.h"
#include "ui_post.h"
#include "configration.h"
#include "actions.h"
#include "ui_assignment.h"

const char *TAG_EVT = "Events";

#define MAX_USER_STRATAGEMS 6

// User button list
lv_obj_t *buttons[MAX_USER_STRATAGEMS];
// Stratagem list index of user buttons
int indices[MAX_USER_STRATAGEMS];
// Stratagem list index of user buttons
int types[MAX_USER_STRATAGEMS];
// Amount of user assigned stratagems
uint8_t strategemsAmount = 0;

lv_timer_t *timerMsg = NULL;

// HID input mask for special keys
#define INPUT_CTRL_MASK 1 // 1 CTRL left

// Goto game screen
void action_goto_game(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		const lv_obj_t *button = buttons[c];
		const lv_img_dsc_t *bgImg = lv_obj_get_style_bg_img_src(button, LV_PART_MAIN | LV_STATE_DEFAULT);
		const bool configured = buttons[c] != NULL;
		lv_obj_t *targetButton = objects.custom_stratagem1;

		bool useHiResIcon = true;

		switch (c)
		{
		case 1:
			targetButton = objects.custom_stratagem2;
			break;
		case 2:
			targetButton = objects.custom_stratagem3;
			break;
		case 3:
			targetButton = objects.custom_stratagem4;
			break;
		case 4:
			targetButton = objects.custom_stratagem5;
			useHiResIcon = false;
			break;
		case 5:
			targetButton = objects.custom_stratagem6;
			useHiResIcon = false;
			break;
		}

		uint8_t itemIndex = indices[c];
		stratagemItem item = strategemItemList[itemIndex];
		const lv_img_dsc_t *hires = useHiResIcon ? item.imgHiRes : bgImg;

		if (configured)
		{
			lv_obj_set_style_border_color(targetButton, lv_color_hex(item.color), LV_PART_MAIN | LV_STATE_DEFAULT);
			lv_obj_set_style_bg_img_src(targetButton, hires, LV_PART_MAIN | LV_STATE_DEFAULT);
			lv_obj_clear_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
		else
		{
			lv_obj_add_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
	}

	lv_scr_load_anim(objects.game, LV_SCR_LOAD_ANIM_MOVE_LEFT, 1000, 0, false);
}

// Update selection in UI (text and bar)
void updateStratagemSelection()
{
	strategemsAmount = 0;

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS - 1; c++)
	{
		if (buttons[c] == NULL)
		{
			buttons[c] = buttons[c + 1];
			indices[c] = indices[c + 1];
			types[c] = types[c + 1];

			buttons[c + 1] = NULL;
			indices[c + 1] = -1;
			types[c + 1] = -1;
		}
	}

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] != NULL)
		{
			strategemsAmount++;
		}
	}

	lv_bar_set_value(objects.bar_amount, strategemsAmount, LV_ANIM_OFF);

	int barColor = colorTheme;

	if (strategemsAmount > 0 && strategemsAmount < 4)
	{
		barColor = sgRed;
	}
	else if (strategemsAmount == 4)
	{
		barColor = sgGreen;
	}
	else if (strategemsAmount > 4)
	{
		barColor = sgBlue;
	}

	lv_obj_set_style_bg_color(objects.bar_amount, lv_color_hex(barColor), LV_PART_MAIN | LV_STATE_DEFAULT);
	lv_obj_set_style_bg_color(objects.bar_amount, lv_color_hex(barColor), LV_PART_INDICATOR | LV_STATE_DEFAULT);

	char textAmount[] = "0 / 0";
	textAmount[0] = (char)(strategemsAmount + '0');
	textAmount[4] = (char)(MAX_USER_STRATAGEMS + '0');

	lv_label_set_text(objects.label_amount, (void *)textAmount);

	if (strategemsAmount == MAX_USER_STRATAGEMS)
	{
		action_goto_game(NULL);
	}
}

// Unassign stratagem item from button
void action_deselect_stratagem(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] == e->current_target)
		{
			buttons[c] = NULL;
			indices[c] = -1;
			types[c] = -1;
		}
	}

	updateStratagemSelection();

	playbackSound(SND_DESELECT);
}

// Assign stratagem item from button
void action_select_stratagem(lv_event_t *e)
{
	if (strategemsAmount < MAX_USER_STRATAGEMS)
	{
		for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
		{
			if (buttons[c] == NULL)
			{
				enum stratagemType type = (enum stratagemType)lv_obj_get_user_data(e->current_target);
				int index = -1;

				for (int c = 0; c < sizeof(strategemItemList); c++)
				{
					stratagemItem item = strategemItemList[c];

					if (item.type == type)
					{
						index = c;
						break;
					}
				}

				buttons[c] = e->current_target;
				indices[c] = index;
				types[c] = type;
				break;
			}
		}

		updateStratagemSelection();

		playbackSound(SND_SELECT);
	}
	else
	{
		lv_obj_clear_state(e->current_target, LV_STATE_CHECKED);

		playbackSound(SND_DESELECT);
	}
}

// Reset all selected stratagems from user
void action_reset_stratagems(lv_event_t *e)
{
	if (strategemsAmount == 0)
	{
		return;
	}

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] != NULL)
		{
			lv_obj_clear_state(buttons[c], LV_STATE_CHECKED);
			buttons[c] = NULL;
			indices[c] = -1;
			types[c] = -1;
		}
	}

	updateStratagemSelection();

	playbackSound(SND_RESET);
}

// Change connectivity (Bluetooth/USB)
void action_change_connectivity(lv_event_t *e)
{
	uint8_t connectionType = lv_dropdown_get_selected(objects.dd_connectivity);

	setConnectivity(connectionType + 1, false);
}

// Change assigned keymap
void action_change_keymap(lv_event_t *e)
{
	uint8_t keymapIndex = lv_dropdown_get_selected(objects.dd_keymap);

	setKeymap(keymapIndex, false);
}

void _executeStdStratagem(uint8_t *sequence, char *path)
{
	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	if (path != NULL)
	{
		playbackSound(path);
	}
}

void _executeUserStratagem(uint8_t index)
{
	uint8_t itemIndex = indices[index];
	stratagemItem item = strategemItemList[itemIndex];

	setStratagemCode(item.sequence, INPUT_CTRL_MASK, false);

	char *path = item.soundPath;

	playbackSound(path);
}

// Trigger 1st standard stratagem
void action_trigger_stratagem_base(lv_event_t *e)
{
	int index = (int)e->user_data;
	uint8_t *sequence = (uint8_t *)strategemBaseList[index].sequence;
	char *path = strategemBaseList[index].soundPath;

	_executeStdStratagem(sequence, path);

	if (index > 5) // Mission stratagems
	{
		lv_scr_load_anim(objects.game, LV_SCR_LOAD_ANIM_NONE, 0, 0, false);
	}
}

// Trigger 1st user stratagem
void action_trigger_stratagem_user(lv_event_t *e)
{
	int index = (int)e->user_data;

	_executeUserStratagem(index);
}

// Trigger keyboard demo (send "hello" via bluetooth connection to host)
void action_keyboard_demo(lv_event_t *e)
{
	uint8_t sequence[8] = {HID_KEY_H,
						   HID_KEY_E,
						   HID_KEY_L,
						   HID_KEY_L,
						   HID_KEY_O,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, 0, true);
}

char *presetKey(lv_obj_t *button, uint8_t itemIndex)
{
	static char key[3] = "p00";

	char presetIndex = '0';

	if (button == objects.btn_preset1)
	{
		presetIndex = '1';
	}
	else if (button == objects.btn_preset2)
	{
		presetIndex = '2';
	}

	char buffer[1];
	itoa(itemIndex, buffer, 10);

	key[1] = presetIndex;
	key[2] = buffer[0];

	return key;
}

void updatePresets()
{
	if (openConfig() != ESP_OK)
	{
		return;
	}

	bool hasPreset1 = getConfig("p10", -1) != -1;
	bool hasPreset2 = getConfig("p20", -1) != -1;

	closeConfig();

	lv_obj_set_style_border_color(objects.btn_preset1, lv_color_hex(hasPreset1 ? sgGreen : sgRed), LV_PART_MAIN | LV_STATE_DEFAULT);
	lv_obj_set_style_border_color(objects.btn_preset2, lv_color_hex(hasPreset2 ? sgGreen : sgRed), LV_PART_MAIN | LV_STATE_DEFAULT);
}

void action_get_preset(lv_event_t *e)
{
	if (openConfig() != ESP_OK)
	{
		return;
	}

	action_reset_stratagems(NULL);

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		char *key = presetKey(e->current_target, c);

		int8_t presetIndex = getConfig(key, -1);
		types[c] = presetIndex;

		if (presetIndex == -1)
		{
			continue;
		}

		uint8_t listIndex = 0;
		uint16_t childIndex = 0;

		lv_obj_t *lists[8] = {
			objects.tab_rifle,
			objects.tab_special,
			objects.tab_backpack,
			objects.tab_supply,
			objects.tab_sentry,
			objects.tab_ground,
			objects.tab_strike,
			objects.tab_eagle};

		while (1)
		{
			lv_obj_t *child = lv_obj_get_child(lists[listIndex], childIndex);

			if (child == NULL)
			{
				if (listIndex < sizeof(lists))
				{
					listIndex++;
					childIndex = 0;
					continue;
				}

				break;
			}

			enum stratagemType type = (enum stratagemType)lv_obj_get_user_data(child);

			if (type == presetIndex)
			{
				int index = -1;

				for (int c = 0; c < sizeof(strategemItemList); c++)
				{
					stratagemItem item = strategemItemList[c];

					if (item.type == type)
					{
						index = c;
						break;
					}
				}

				buttons[c] = child;
				indices[c] = index;

				lv_obj_add_state(child, LV_STATE_CHECKED);
				break;
			}

			childIndex++;
		}
	}

	closeConfig();

	updateStratagemSelection();

	if (strategemsAmount == 0)
	{
		showMsgBox("Preset\nempty");
	}
	else
	{
		showMsgBox("Preset\nloaded");
	}
}

void action_set_preset(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		char *key = presetKey(e->current_target, c);

		setConfig(key, types[c]);
	}

	updatePresets();

	playbackSound(SND_DESELECT);

	if (strategemsAmount == 0)
	{
		showMsgBox("Preset\ncleared");
	}
	else
	{
		showMsgBox("Preset\nsaved");
	}
}

void showMsgBox(char *msg)
{
	lv_label_set_text(objects.msg_label, msg);
	lv_obj_clear_flag(objects.msg_box, LV_OBJ_FLAG_HIDDEN);

	if (timerMsg != NULL)
	{
		lv_timer_del(timerMsg);
		timerMsg = NULL;
	}

	timerMsg = lv_timer_create(hideMsgBox, 1000, NULL);
}

void hideMsgBox(lv_timer_t *timer)
{
	if (timerMsg != NULL)
	{
		lv_timer_del(timerMsg);
		timerMsg = NULL;
	}

	lv_obj_add_flag(objects.msg_box, LV_OBJ_FLAG_HIDDEN);
}