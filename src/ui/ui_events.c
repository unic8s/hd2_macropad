// This file was generated by SquareLine Studio
// SquareLine Studio version: SquareLine Studio 1.5.0
// LVGL version: 8.3.11
// Project name: SquareLine_Project

#include "ui.h"
#include "screens.h"
#include "hid_dev.h"
#include "esp_log.h"
#include "stratagems.h"
#include "i2s_player.h"
#include "main.h"
#include "ui_post.h"
#include "configration.h"
#include "ui_assignment.h"

const char *TAG_EVT = "Events";

#define MAX_USER_STRATAGEMS 6

// User button list
lv_obj_t *buttons[MAX_USER_STRATAGEMS];
// Stratagem list index of user buttons
int indices[MAX_USER_STRATAGEMS];
// Stratagem list index of user buttons
int types[MAX_USER_STRATAGEMS];
// Amount of user assigned stratagems
uint8_t strategemsAmount = 0;

// HID input mask for special keys
#define INPUT_CTRL_MASK 1 // 1 CTRL left

// Goto game screen
void action_setup_2_game(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		const lv_obj_t *button = buttons[c];
		const lv_img_dsc_t *bgImg = lv_obj_get_style_bg_img_src(button, LV_PART_MAIN | LV_STATE_DEFAULT);
		const bool configured = buttons[c] != NULL;
		lv_obj_t *targetButton = objects.custom_stratagem1;

		bool useHiResIcon = true;

		switch (c)
		{
		case 1:
			targetButton = objects.custom_stratagem2;
			break;
		case 2:
			targetButton = objects.custom_stratagem3;
			break;
		case 3:
			targetButton = objects.custom_stratagem4;
			break;
		case 4:
			targetButton = objects.custom_stratagem5;
			useHiResIcon = false;
			break;
		case 5:
			targetButton = objects.custom_stratagem6;
			useHiResIcon = false;
			break;
		}

		uint8_t itemIndex = indices[c];
		stratagem item = strategems[itemIndex];
		const lv_img_dsc_t *hires = useHiResIcon ? item.imgHiRes : bgImg;

		if (configured)
		{
			lv_obj_set_style_border_color(targetButton, lv_color_hex(item.color), LV_PART_MAIN | LV_STATE_DEFAULT);
			lv_obj_set_style_bg_img_src(targetButton, hires, LV_PART_MAIN | LV_STATE_DEFAULT);
			lv_obj_clear_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
		else
		{
			lv_obj_add_flag(targetButton, LV_OBJ_FLAG_HIDDEN);
		}
	}

	lv_scr_load_anim(objects.game, LV_SCR_LOAD_ANIM_MOVE_LEFT, 1000, 0, false);
}

// Update selection in UI (text and bar)
void updateStratagemSelection()
{
	strategemsAmount = 0;

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS - 1; c++)
	{
		if (buttons[c] == NULL)
		{
			buttons[c] = buttons[c + 1];
			indices[c] = indices[c + 1];
			types[c] = types[c + 1];

			buttons[c + 1] = NULL;
			indices[c + 1] = -1;
			types[c + 1] = -1;
		}
	}

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] != NULL)
		{
			strategemsAmount++;
		}
	}

	lv_bar_set_value(objects.bar_amount, strategemsAmount, LV_ANIM_OFF);

	int barColor = colorTheme;

	if (strategemsAmount > 0 && strategemsAmount < 4)
	{
		barColor = sgRed;
	}
	else if (strategemsAmount == 4)
	{
		barColor = sgGreen;
	}
	else if (strategemsAmount > 4)
	{
		barColor = sgBlue;
	}

	lv_obj_set_style_bg_color(objects.bar_amount, lv_color_hex(barColor), LV_PART_MAIN | LV_STATE_DEFAULT);
	lv_obj_set_style_bg_color(objects.bar_amount, lv_color_hex(barColor), LV_PART_INDICATOR | LV_STATE_DEFAULT);

	char textAmount[] = "0 / 0";
	textAmount[0] = (char)(strategemsAmount + '0');
	textAmount[4] = (char)(MAX_USER_STRATAGEMS + '0');

	lv_label_set_text(objects.label_amount, (void *)textAmount);

	if (strategemsAmount == MAX_USER_STRATAGEMS)
	{
		action_setup_2_game(NULL);
	}
}

// Unassign stratagem item from button
void action_deselect_stratagem(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] == e->target)
		{
			buttons[c] = NULL;
			indices[c] = -1;
			types[c] = -1;
		}
	}

	updateStratagemSelection();

	playbackSound(SND_DESELECT);
}

// Assign stratagem item from button
void action_select_stratagem(lv_event_t *e)
{
	if (strategemsAmount < MAX_USER_STRATAGEMS)
	{
		for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
		{
			if (buttons[c] == NULL)
			{
				enum stratagemType type = (enum stratagemType)lv_obj_get_user_data(e->target);
				int index = -1;

				for (int c = 0; c < sizeof(strategems); c++)
				{
					stratagem item = strategems[c];

					if (item.type == type)
					{
						index = c;
						break;
					}
				}

				buttons[c] = e->target;
				indices[c] = index;
				types[c] = type;
				break;
			}
		}

		updateStratagemSelection();

		playbackSound(SND_SELECT);
	}
	else
	{
		lv_obj_clear_state(e->target, LV_STATE_CHECKED);

		playbackSound(SND_DESELECT);
	}
}

// Reset all selected stratagems from user
void action_reset_stratagems(lv_event_t *e)
{
	if (strategemsAmount == 0)
	{
		return;
	}

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		if (buttons[c] != NULL)
		{
			lv_obj_clear_state(buttons[c], LV_STATE_CHECKED);
			buttons[c] = NULL;
			indices[c] = -1;
			types[c] = -1;
		}
	}

	updateStratagemSelection();

	playbackSound(SND_RESET);
}

// Change connectivity (Bluetooth/USB)
void action_change_connectivity(lv_event_t *e)
{
	uint8_t connectionType = lv_dropdown_get_selected(objects.dd_connectivity);

	setConnectivity(connectionType + 1, false);
}

// Change assigned keymap
void action_change_keymap(lv_event_t *e)
{
	uint8_t keymapIndex = lv_dropdown_get_selected(objects.dd_keymap);

	setKeymap(keymapIndex, false);
}

void _executeStdStratagem(uint8_t *sequence, char *path)
{
	setStratagemCode(sequence, INPUT_CTRL_MASK, false);

	if (path != NULL)
	{
		playbackSound(path);
	}
}

void _executeUserStratagem(uint8_t index)
{
	uint8_t itemIndex = indices[index];
	stratagem item = strategems[itemIndex];

	setStratagemCode(item.sequence, INPUT_CTRL_MASK, false);

	char *path = item.soundPath;

	playbackSound(path);
}

// Trigger 1st standard stratagem
void action_trigger_stratagem_std(lv_event_t *e)
{
	if (e->target == objects.btn_reinforce)
	{
		uint8_t sequence[8] = {INPUT_UP,
							   INPUT_DOWN,
							   INPUT_RIGHT,
							   INPUT_LEFT,
							   INPUT_UP,
							   0,
							   0,
							   0};

		_executeStdStratagem(sequence,
							 SND_REINFORCE);
	}
	else if (e->target == objects.btn_resupply)
	{
		uint8_t sequence[8] = {INPUT_DOWN,
							   INPUT_DOWN,
							   INPUT_UP,
							   INPUT_RIGHT,
							   0,
							   0,
							   0,
							   0};

		_executeStdStratagem(sequence, SND_SUPPLY);
	}
	else if (e->target == objects.btn_sos)
	{
		uint8_t sequence[8] = {INPUT_UP,
							   INPUT_DOWN,
							   INPUT_RIGHT,
							   INPUT_UP,
							   0,
							   0,
							   0,
							   0};

		_executeStdStratagem(sequence, SND_SOS);
	}
	else if (e->target == objects.btn_rearm)
	{
		uint8_t sequence[8] = {INPUT_UP,
							   INPUT_UP,
							   INPUT_LEFT,
							   INPUT_UP,
							   INPUT_RIGHT,
							   0,
							   0,
							   0};

		_executeStdStratagem(sequence, SND_EAGLE_RELOAD);
	}
	else if (e->target == objects.btn_hellbomb)
	{
		uint8_t sequence[8] = {INPUT_DOWN,
							   INPUT_UP,
							   INPUT_LEFT,
							   INPUT_DOWN,
							   INPUT_UP,
							   INPUT_RIGHT,
							   INPUT_DOWN,
							   INPUT_UP};

		_executeStdStratagem(sequence, NULL);
	}
	else if (e->target == objects.btn_seaf)
	{
		uint8_t sequence[8] = {INPUT_RIGHT,
							   INPUT_UP,
							   INPUT_UP,
							   INPUT_DOWN,
							   0,
							   0,
							   0,
							   0};

		_executeStdStratagem(sequence, NULL);
	}
}

// Trigger 1st user stratagem
void action_trigger_stratagem_user(lv_event_t *e)
{
	int8_t index = -1;

	if (e->target == objects.custom_stratagem1)
	{
		index = 0;
	}
	else if (e->target == objects.custom_stratagem2)
	{
		index = 1;
	}
	else if (e->target == objects.custom_stratagem3)
	{
		index = 2;
	}
	else if (e->target == objects.custom_stratagem4)
	{
		index = 3;
	}
	else if (e->target == objects.custom_stratagem5)
	{
		index = 4;
	}
	else if (e->target == objects.custom_stratagem6)
	{
		index = 5;
	}

	if (index >= 0)
	{
		_executeUserStratagem(index);
	}
}

// Change HID input delay
void action_change_delay(lv_event_t *e)
{
	int32_t delay = lv_slider_get_value(e->target);

	setDelay(delay * 10, false);
}

// Change display brightness
void action_change_brightness(lv_event_t *e)
{
	int32_t brightness = lv_slider_get_value(e->target);

	setBrightness(brightness * 10, false);
}

// Change sound mute (on/off)
void action_mute_sound(lv_event_t *e)
{
	bool muted = lv_obj_get_state(e->target) & LV_STATE_CHECKED ? true : false;

	setMuted(muted, false);
}

// Trigger keyboard demo (send "hello" via bluetooth connection to host)
void action_keyboard_demo(lv_event_t *e)
{
	uint8_t sequence[8] = {HID_KEY_H,
						   HID_KEY_E,
						   HID_KEY_L,
						   HID_KEY_L,
						   HID_KEY_O,
						   0,
						   0,
						   0};

	setStratagemCode(sequence, 0, true);
}

// Trigger when tab navigation has changed
void action_tab_changed(lv_event_t *e)
{
	playbackSound(SND_SWIPE);
}

// Change screen orientation
void action_flip_screen(lv_event_t *e)
{
	bool flip = lv_obj_get_state(e->target) & LV_STATE_CHECKED ? true : false;

	setRotation(flip ? LV_DISP_ROT_270 : LV_DISP_ROT_90, false);

	esp_restart();
}

void action_restart_device(lv_event_t *e)
{
	esp_restart();
}

char *presetKey(lv_obj_t *button, uint8_t itemIndex)
{
	static char key[3] = "p00";

	char presetIndex = '0';

	if (button == objects.btn_preset1)
	{
		presetIndex = '1';
	}
	else if (button == objects.btn_preset2)
	{
		presetIndex = '2';
	}

	char buffer[1];
	itoa(itemIndex, buffer, 10);

	key[1] = presetIndex;
	key[2] = buffer[0];

	return key;
}

void updatePresets()
{
	if (openConfig() != ESP_OK)
	{
		return;
	}

	bool hasPreset1 = getConfig("p10", -1) != -1;
	bool hasPreset2 = getConfig("p20", -1) != -1;

	closeConfig();

	lv_obj_set_style_border_color(objects.btn_preset1, lv_color_hex(hasPreset1 ? sgGreen : sgRed), LV_PART_MAIN | LV_STATE_DEFAULT);
	lv_obj_set_style_border_color(objects.btn_preset2, lv_color_hex(hasPreset2 ? sgGreen : sgRed), LV_PART_MAIN | LV_STATE_DEFAULT);
}

void action_get_preset(lv_event_t *e)
{
	if (openConfig() != ESP_OK)
	{
		return;
	}

	action_reset_stratagems(NULL);

	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		char *key = presetKey(e->target, c);

		int8_t presetIndex = getConfig(key, -1);
		types[c] = presetIndex;

		if (presetIndex == -1)
		{
			continue;
		}

		uint8_t listIndex = 0;
		uint16_t childIndex = 0;

		lv_obj_t *lists[8] = {
			objects.tab_rifle,
			objects.tab_special,
			objects.tab_backpack,
			objects.tab_supply,
			objects.tab_sentry,
			objects.tab_ground,
			objects.tab_strike,
			objects.tab_eagle};

		while (1)
		{
			lv_obj_t *child = lv_obj_get_child(lists[listIndex], childIndex);

			if (child == NULL)
			{
				if (listIndex < 6)
				{
					listIndex++;
					childIndex = 0;
					continue;
				}

				break;
			}

			enum stratagemType type = (enum stratagemType)lv_obj_get_user_data(child);

			if (type == presetIndex)
			{
				int index = -1;

				for (int c = 0; c < sizeof(strategems); c++)
				{
					stratagem item = strategems[c];

					if (item.type == type)
					{
						index = c;
						break;
					}
				}

				buttons[c] = child;
				indices[c] = index;

				lv_obj_add_state(child, LV_STATE_CHECKED);
				break;
			}

			childIndex++;
		}
	}

	closeConfig();

	updateStratagemSelection();

	PresetLoadAnim_Animation(e->target, 0);
}

void action_set_preset(lv_event_t *e)
{
	for (uint8_t c = 0; c < MAX_USER_STRATAGEMS; c++)
	{
		char *key = presetKey(e->target, c);

		setConfig(key, types[c]);
	}

	updatePresets();

	playbackSound(SND_DESELECT);

	PresetSaveAnim_Animation(e->target, 0);
}

void action_reset_cancel(lv_event_t *e)
{
	lv_scr_load_anim(objects.config, LV_SCR_LOAD_ANIM_FADE_OUT, 500, 0, false);
}

void action_reset_confirm(lv_event_t *e)
{
	resetConfig();

	lv_scr_load_anim(objects.config, LV_SCR_LOAD_ANIM_FADE_OUT, 500, 0, false);
}

void action_intro_2_setup(lv_event_t *e)
{
	assignStratagems();

	lv_scr_load_anim(objects.setup, LV_SCR_LOAD_ANIM_MOVE_BOTTOM, 1000, 1000, false);
}

void action_setup_2_config(lv_event_t *e)
{
	lv_scr_load_anim(objects.config, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 1000, 0, false);
}

void action_config_2_about(lv_event_t *e)
{
	lv_scr_load_anim(objects.about, LV_SCR_LOAD_ANIM_MOVE_TOP, 1000, 0, false);
}

void action_about_2_config(lv_event_t *e)
{
	lv_scr_load_anim(objects.config, LV_SCR_LOAD_ANIM_MOVE_BOTTOM, 1000, 0, false);
}

void action_config_2_reset(lv_event_t *e)
{
	lv_scr_load_anim(objects.reset, LV_SCR_LOAD_ANIM_FADE_IN, 500, 0, false);
}

void action_config_2_setup(lv_event_t *e)
{
	lv_scr_load_anim(objects.setup, LV_SCR_LOAD_ANIM_MOVE_LEFT, 1000, 0, false);
}

void action_game_2_setup(lv_event_t *e)
{
	lv_scr_load_anim(objects.setup, LV_SCR_LOAD_ANIM_MOVE_RIGHT, 1000, 0, false);
}